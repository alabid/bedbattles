import os

from flask import Flask
from flask import render_template
from flask import request
from pymongo import Connection
from twilio.rest import TwilioRestClient
from datetime import datetime
app = Flask(__name__)

@app.route('/')
def hello():
	return render_template("index.html")

@app.route('/register/', methods=['GET', 'POST'])
def register():
	
	try:
	       	username = request.form.get('currentUserName')
       		uid = request.form.get('currentUser')
		email = request.form.get('currentUserEmail')
		#username = "test"
		#uid = 123456789
		#email = "testemail"
		post = {"name": username, "uid": uid, "email": email}
		connection = Connection("mongodb://heroku:54cce0fe06c2ec87c6c0ede29923b6e0@flame.mongohq.com:27028/app5293195")
		db = connection.app5293195
		users = db.users
		duplicate = users.find_one({"uid": uid})
		if not duplicate:
			users.insert(post)
			return "success"
		else:
			return "duplicate"
	except:
		return "failure"
		
@app.route('/sms/<uid>', methods=['GET', 'POST'])
def sms(uid):
	#try:
		account = "AC720f0500e36bbb4afa8e2d52e360e3ba"
		token = "bb5de69f671b98f875277f69c0d0b497"
		client = TwilioRestClient(account, token)

		connection = Connection("mongodb://heroku:54cce0fe06c2ec87c6c0ede29923b6e0@flame.mongohq.com:27028/app5293195")
		db = connection.app5293195
		battles = db.battles
		users = db.users
		battle = battles.find_one({"$or" : [ {"user1" : uid}, {"user2": uid} ]})
		battleid = battle['battleid']
		if battle['user1'] == uid:
			opponentid = battle['user2']
		if battle['user2'] == uid:
			opponentid = battle['user1']

		opponentdoc = users.find_one({'uid' : opponentid})
		opponent = opponentdoc['name']
		challengeURL = 'http://freezing-day-7773.herokuapp.com/battle/'+battleid+'/'+uid
		message = client.sms.messages.create(to="+19145884793", from_="+14155992671", body="Good morning! Start your BedBattle with "+opponent+": "+challengeURL)
		return "success"
	#except:
		#return "failure"

@app.route('/battle/<battleid>/<uid>', methods=['GET', 'POST'])
def battle(battleid, uid):
	if request.method == 'POST':
		win = request.form.get("win")
		if win=="true":
			#add to db
			connection = Connection("mongodb://heroku:54cce0fe06c2ec87c6c0ede29923b6e0@flame.mongohq.com:27028/app5293195")
			db = connection.app5293195
			wakeups = db.wakeups
			time = datetime.now()
			month = time.month
			day = time.day
			wakeups.update({"battleid": battleid, "uid": uid, "month": month, "day": day}, {"win": "true"}, false, false)
	else:
	#try:
		connection = Connection("mongodb://heroku:54cce0fe06c2ec87c6c0ede29923b6e0@flame.mongohq.com:27028/app5293195")
		db = connection.app5293195
		wakeups = db.wakeups
		time = datetime.now()
		hour = time.hour
		minute = time.minute
		month = time.month
		day = time.day
		post = {"battleid": battleid, "uid": uid, "month": month, "day": day, "hour": hour, "minute": minute, "win": false}
		wakeups.insert(post)
		return "success"
		#return render_template("/battles/1.html")
	#except:
		#return "failure"

@app.route('/battle/<battleid>')
def visualize(battleid):
	connection = Connection("mongodb://heroku:54cce0fe06c2ec87c6c0ede29923b6e0@flame.mongohq.com:27028/app5293195")
	db = connection.app529319
	battles = db.battles
	battle = battles.find_one({"battleid": battleid})
	return battle['wake1']+" vs "+battle['wake2']

@app.route('/createbattle/', methods=['GET', 'POST'])
def createbattle():
	try:
		user1 = request.form.get('user1')
		user2 = request.form.get('user2')
		wake1hour = request.form.get('wake1hour')
		wake1minute = request.form.get('wake1minute')
		wake2hour = request.form.get('wake2hour')
		wake2minute = request.form.get('wake2minute')
		connection = Connection("mongodb://heroku:54cce0fe06c2ec87c6c0ede29923b6e0@flame.mongohq.com:27028/app5293195")
		db = connection.app5293195
		battles = db.battles
		battleid = os.urandom(16).encode('hex')
		post = {"user1": user1, "user2": user2, "wake1hour": wake1hour, "wake1minute": wake1minute, "wake2hour": wake2hour, "wake2minute": wake2minute, "battleid": battleid}
		battles.insert(post)
		return "success"
	except:
		return "failure"

if __name__ == '__main__':
	port = int(os.environ.get('PORT', 55641))
	app.run(debug=True, host='0.0.0.0', port=port)
